# RAG Copilot - Система Retrieval-Augmented Generation

Масштабируемая система RAG на основе микросервисной архитектуры.

## Описание проекта

RAG Copilot - это комплексная система Retrieval-Augmented Generation (RAG), реализованная в виде набора микросервисов. Система позволяет загружать документы, преобразовывать их в векторные представления и выполнять семантический поиск по содержимому документов.

## Архитектура

Система построена по архитектуре микросервисов с использованием gRPC для коммуникации между сервисами. Основной рабочий процесс включает в себя конвертацию документов, их разделение на фрагменты, генерацию эмбеддингов, индексацию в векторной базе данных и выполнение семантического поиска.

```
┌─────────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Документы     │───▶│ Converter   │───▶│   Chunker   │───▶│  Embedder   │───▶│   Indexer   │
└─────────────────┘    └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
         │                       │                      │                │                  │
         │                       │                      │                │                  │
         │                       ▼                      ▼                ▼                  ▼
         │                ┌─────────────┐        ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
         │                │   Manager   │───────▶│   Chunker   │───▶│  Embedder   │───▶│   Qdrant    │
         │                │ (File Mgmt) │        │             │    │             │    │ (Vector DB) │
         │                └─────────────┘        └─────────────┘    └─────────────┘    └─────────────┘
         │                       │                                           │
         │                       ▼                                           │
         │                ┌─────────────┐                                    │
         │                │  Web UI     │                                    │
         │                │ (Monitor)   │                                    │
         │                └─────────────┘                                    │
         │                       │                                          │
         ▼                       ▼                                          │
┌─────────────────┐    ┌─────────────────┐    ┌─────────────┐              │
│   WebSearch     │◀───│   Searcher      │───▶│  Generator  │              │
│ (Search & Gen)  │    │ (Semantic      │    │ (LLM Answer)│              │
└─────────────────┘    │   Search)       │    └─────────────┘              │
         ▲             └─────────────────┘         │                        │
         │                       │                 │                        │
         └───────────────────────┼─────────────────┼────────────────────────┘
                                 │                 │
┌─────────────────┐              │                 │
│   WebConfig     │              │                 │
│ (Config Mgmt)   │              │                 │
└─────────────────┘              │                 │
         │                       │                 │
         ▼                       ▼                 ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   WebAdmin      │    │   Clients       │    │   External      │
│ (System Admin)  │    │ (REST API)      │    │   Services      │
└─────────────────┘    └─────────────────┘    └─────────────────┘

Коммуникация между сервисами:
- gRPC: Manager ↔ Converter/Indexer, Indexer ↔ Chunker/Embedder, Searcher ↔ Embedder,
        WebSearch ↔ Searcher/Generator
- HTTP/REST: Web UI ↔ Manager, WebConfig ↔ all services, WebSearch ↔ clients,
        WebAdmin ↔ all services
- Direct DB: Indexer ↔ Qdrant (vector storage), Manager ↔ SQLite (files.db)
```

### Поток данных

1. Документы поступают и направляются в сервис **Converter**
2. Сконвертированные документы направляются в сервис **Chunker**
3. Фрагменты обрабатываются сервисом **Embedder** для генерации векторов
4. Векторы и метаданные индексируются сервисом **Indexer** в Qdrant
5. Поисковые запросы обрабатываются сервисом **Searcher**
6. Результаты возвращаются через веб-интерфейс **WebSearch** или другие клиентские приложения

## Микросервисы

### 1. Converter Service (Конвертация документов)
- Назначение: Конвертация PDF-документов в формат Markdown с использованием библиотеки Docling
- Расположение: `./services/converter/`
- Функциональность: Поддержка конвертации PDF с возможностью OCR, акселерация GPU, работа в автономном режиме с локально хранимыми моделями

### 2. Chunker Service (Разделение текста)
- Назначение: Разделение текстовых документов на более мелкие фрагменты для систем RAG
- Расположение: `./services/chunker/`
- Функциональность: Прием текста из файлов или памяти, поддержка настраиваемого размера фрагментов и перекрытия, использование рекурсивного разделителя символов

### 3. Embedder Service (Генерация эмбеддингов)
- Назначение: Генерация векторных эмбеддингов из текстовых фрагментов с использованием трансформерных моделей
- Расположение: `./services/embedder/`
- Функциональность: Прием текста и возврат векторных эмбеддингов, поддержка пакетной обработки, настраиваемый путь к модели и устройству

### 4. Indexer Service (Индексация)
- Назначение: Оркестрация индексации документов с координацией сервисов фрагментации и эмбеддинга
- Расположение: `./services/indexer/`
- Функциональность: Прием .md файлов и метаданных через gRPC streaming, обработка документов через сервисы фрагментации и эмбеддинга, сохранение в векторной базе данных Qdrant

### 5. Searcher Service (Поиск)
- Назначение: Семантический поисковый движок, который делает запросы к векторной базе данных с использованием эмбеддингов
- Расположение: `./services/searcher/`
- Функциональность: Прием текстовых запросов, генерация эмбеддингов, выполнение поиска схожести в Qdrant, возврат результатов с метаданными

### 6. Generator Service (Генерация ответов)
- Назначение: Генерация ответов на основе найденных документов с использованием LLM
- Расположение: `./services/generator/`
- Функциональность: Прием контекста из поисковых результатов, генерация ответов с использованием локальных LLM

### 7. Manager Service (Управление файлами)
- Назначение: Управление файлами и метаданными документов
- Расположение: `./services/manager/`
- Функциональность: Хранение информации о загруженных документах, управление жизненным циклом документов

### 8. Web UI Service (Веб-интерфейс)
- Назначение: Веб-интерфейс для мониторинга и управления сервисами обработки файлов
- Расположение: `./services/web_ui/`
- Функциональность: Отображение статуса сервиса и статистики файлов, управление файлами, построен на Flask

### 9. WebConfig Service (Конфигурация веб-интерфейса)
- Назначение: Централизованный веб-интерфейс для управления конфигурациями всех микросервисов
- Расположение: `./services/webconfig/`
- Функциональность: Просмотр и редактирование конфигураций, обновление файлов config.json, управление сервисами

### 10. WebSearch Service (Веб-поиск)
- Назначение: Веб-интерфейс для системы поиска RAG
- Расположение: `./services/websearch/`
- Функциональность: Предоставление удобного интерфейса поиска, подключение к сервису поиска через gRPC, REST API-эндпоинты

### 11. WebAdmin Service (Администрирование)
- Назначение: Административный интерфейс для управления всей системой
- Расположение: `./services/webadmin/`
- Функциональность: Мониторинг состояния всех сервисов, управление пользователями, статистика использования

## Структура проекта

```
RAG-Copilot/
├── README.md                 # Этот файл
├── requirements.txt          # Зависимости проекта
├── .gitignore              # Файлы, исключенные из репозитория
├── start_all_services.py   # Скрипт для запуска всех сервисов
├── START_ALL_SERVICES.md   # Документация по запуску сервисов
├── files.db               # База данных файлов
├── files/                 # Директория для хранения файлов
├── services/              # Директория с микросервисами
│   ├── chunker/           # Сервис фрагментации
│   ├── converter/         # Сервис конвертации
│   ├── embedder/          # Сервис генерации эмбеддингов
│   ├── generator/         # Сервис генерации ответов
│   ├── indexer/           # Сервис индексации
│   ├── manager/           # Сервис управления файлами
│   ├── searcher/          # Сервис поиска
│   ├── web_ui/            # Веб-интерфейс
│   ├── webadmin/          # Административный интерфейс
│   ├── webconfig/         # Веб-интерфейс конфигурации
│   └── websearch/         # Веб-поиск
├── static/                # Статические файлы
└── templates/             # Шаблоны для веб-интерфейсов
```

## Требования

- Python 3.8 или выше
- pip: менеджер пакетов Python
- Docker: для запуска Qdrant (векторной базы данных)
- Git: для клонирования репозитория

### Зависимости

Проект использует следующие основные зависимости:

- Веб-фреймворки: `flask`, `fastapi`, `uvicorn`
- gRPC: `grpcio`, `grpcio-tools`, `protobuf`
- Векторная БД: `qdrant-client`
- Обработка документов: `docling`, `pymupdf`
- ML/ИИ: `transformers`, `torch`, `sentence-transformers`, `llama-cpp-python`
- Утилиты: `requests`, `python-dotenv`, `psutil`, `nltk`, `numpy`, `scikit-learn`

Для установки всех зависимостей выполните:

```bash
pip install -r requirements.txt
```

## Установка

### Клонирование репозитория

```bash
git clone <URL_репозитория>
cd RAG-Copilot
```

### Создание виртуального окружения (рекомендуется)

```bash
python -m venv venv
source venv/bin/activate  # На Windows: venv\Scripts\activate
```

### Установка зависимостей

```bash
pip install -r requirements.txt
```

### Установка и запуск Qdrant (векторной базы данных)

```bash
docker run -d --name qdrant-container -p 6333:6333 qdrant/qdrant
```

### Настройка конфигурации

Для каждого сервиса создайте соответствующий файл `config.json` в его директории, если он не существует.

## Запуск

### Запуск всех сервисов одновременно

Для удобства запуска всех сервисов одновременно используется скрипт `start_all_services.py`:

```bash
python start_all_services.py
```

Этот скрипт запускает все микросервисы в отдельных процессах и предоставляет возможность мониторинга их состояния. Для остановки всех сервисов нажмите `Ctrl+C`.

### Запуск отдельных сервисов

Каждый сервис может быть запущен отдельно из своей директории:

```bash
cd services/converter
python converter.py
```

Повторите для каждого сервиса, который вы хотите запустить.

### Порты по умолчанию

| Сервис | Порт |
|--------|------|
| Converter | 50053 |
| Chunker | 50052 |
| Embedder | 50051 |
| Indexer | 50054 |
| Searcher | 50055 |
| Web UI | 5000 |
| WebConfig | 50055 |
| WebSearch | 8001 |
| Qdrant | 6333 |

## Конфигурация

Каждый сервис имеет свой собственный файл `config.json` для настройки. Сервис WebConfig предоставляет централизованный способ управления всеми конфигурациями через веб-интерфейс.

Все сервисы используют унифицированную структуру конфигурационных файлов, включающую следующие разделы:

- `server` - настройки сервера (host, port, max_workers)
- `logging` - настройки логирования (уровень, файл, формат)
- `model` - настройки модели (для сервисов, использующих ML-модели)
- `chunking` - настройки фрагментации (для сервиса chunker)
- `data` - настройки данных (базовая директория и т.д.)
- `system` - системные настройки (количество потоков, рабочая директория и т.д.)
- `docling` - настройки для сервиса конвертации документов

## Использование

### Основной рабочий процесс

1. Загрузите документы через веб-интерфейс или API
2. Документы будут автоматически обработаны через цепочку сервисов: Конвертация → Фрагментация → Генерация эмбеддингов → Индексация
3. Используйте веб-интерфейс поиска или API для выполнения запросов
4. Получите семантически релевантные результаты из вашей коллекции документов

### Примеры использования

- Поиск по документации: быстро находите нужную информацию в больших объемах текста
- Анализ контрактов: извлекайте ключевые условия из юридических документов
- Обработка научных статей: находите релевантные исследования и данные
- Поддержка клиентов: предоставляйте точные ответы на часто задаваемые вопросы