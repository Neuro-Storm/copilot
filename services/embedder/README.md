# Микросервис эмбеддинга

Этот микросервис принимает фрагменты текста в качестве входных данных и возвращает векторы эмбеддинга с использованием предварительно обученной модели. В качестве протокола связи используется gRPC, и он предназначен для интеграции в более крупную систему RAG (Retrieval-Augmented Generation).

## Архитектура

Сервис эмбеддинга реализует gRPC-сервис, который:
- Принимает фрагменты текста
- Преобразует их в векторы эмбеддинга с использованием трансформерной модели
- Возвращает векторы эмбеддинга в качестве ответов

## Зависимости

Сервис требует следующие Python-пакеты:
- grpcio
- grpcio-tools
- transformers
- torch
- protobuf

Установите зависимости с помощью:
```bash
pip install -r requirements.txt
```

## Конфигурация

Сервис считывает свою конфигурацию из файла `config.json`, который включает:
- Настройки сервера (хост, порт, количество потоков, TLS-настройки)
- Настройки модели (путь к модели, устройство, максимальная длина текста)
- Настройки логирования

Пример конфигурации:
```json
{
  "server": {
    "host": "[::]",
    "port": 50051,
    "max_workers": 4,
    "gpu_max_workers": 1
  },
  "model": {
    "path": "./models/models--ai-forever--ru-en-RoSBERTa",
    "device": "cpu",
    "max_length": 512
  },
  "logging": {
    "level": "INFO",
    "file": "embedder.log",
    "format": "%(asctime)s [%(levelname)s] %(name)s: %(message)s"
  }
}
```

Параметры конфигурации:
- `server.gpu_max_workers` - максимальное количество рабочих потоков при использовании GPU (для предотвращения пиков памяти)
- `model.max_length` - максимальная длина токенизированного текста

Параметр `device` может принимать значения:
- `"cpu"` - использовать центральный процессор
- `"gpu"` - использовать графический процессор (если доступен)

## Использование

Для запуска сервиса эмбеддинга:
```bash
python embedder.py
```

## Протокол

Сервис использует gRPC с следующим интерфейсом, определенным в `embedder.proto`:

```protobuf
service EmbedderService {
  // Генерирует эмбеддинг для одного текста
  rpc GetEmbedding(TextChunk) returns (EmbeddingVector);
  // Генерирует эмбеддинги для списка текстов (batch processing)
  rpc GetEmbeddings(TextChunks) returns (EmbeddingVectors);
}

message TextChunk {
  string text = 1;
}

message TextChunks {
  repeated string texts = 1;
}

message EmbeddingVector {
  repeated float values = 1;
}

message EmbeddingVectors {
  repeated EmbeddingVector vectors = 1;
}
```

## Модели

Сервис ожидает модель эмбеддинга в каталоге `models/`. По умолчанию ищет модель в `./models/models--ai-forever--ru-en-RoSBERTa`. В настоящее время поддерживаются трансформерные модели Hugging Face.

## Логи

Сервис записывает логи как в stdout, так и в файл, указанный в конфигурации (по умолчанию `embedder.log`).

## Интеграция

Этот микросервис предназначен для интеграции с другими сервисами в системе RAG. Клиенты могут подключаться к gRPC-сервису для получения эмбеддингов для фрагментов текста, которые могут использоваться для поиска схожих элементов и других задач.