# Микросервис управления файлами для RAG системы

Этот микросервис является частью системы RAG (Retrieval-Augmented Generation) и выполняет следующие функции:

## Функциональность

1. **Сканирование каталога файлов** - периодически проверяет указанный каталог на наличие новых файлов
2. **Конвертация файлов** - отправляет файлы в микросервис `converter` по протоколу gRPC для преобразования в формат markdown
3. **Индексация документов** - отправляет конвертированные файлы и метаданные в микросервис `indexer` по протоколу gRPC
4. **Управление состоянием** - ведет базу данных с информацией о всех файлах: название, пути, статус индексации
5. **HTTP API** - предоставляет API для взаимодействия с веб-интерфейсом
6. **Многопоточная обработка** - использует пул рабочих потоков для параллельной обработки файлов
7. **Безопасность** - проверка путей к файлам для предотвращения path traversal атак
8. **Аутентификация** - поддержка Basic Authentication для защищенных эндпоинтов

## Архитектура

Микросервис состоит из следующих компонентов:

- `FileManager` - управляет базой данных файлов, сканирует директорию, управляет статусами файлов
- `Manager` - основной класс, координирующий работу, обрабатывает файлы, управляет очередью
- `Config` - загрузка и управление параметрами конфигурации
- gRPC клиенты для взаимодействия с внешними сервисами (converter, indexer)
- HTTP API для взаимодействия с веб-интерфейсом и другими сервисами
- Механизмы аутентификации и безопасности

## Статусы файлов

- `pending` - файл обнаружен, ожидает обработки
- `processing` - файл в процессе обработки
- `conversion_success_only` - файл успешно сконвертирован, но индексация не удалась
- `indexed` - файл успешно обработан и проиндексирован
- `failed` - произошла ошибка при обработке файла
- `deleted` - файл был удален из каталога

## Запуск

Для запуска микросервиса:

1. Убедитесь, что запущены микросервисы converter (по умолчанию на порту 50053) и indexer (по умолчанию на порту 50054)
2. Запустите микросервис:
```bash
python manager.py
```

Микросервис будет запущен с HTTP API на порту 5001 (настраивается в config.json)

## Конфигурация

Конфигурация находится в файле `config.json`:

```json
{
  "files_dir": "./files",
  "db_path": "files.db",
  "converter_address": "localhost:50053",
  "indexer_address": "localhost:50054",
  "scan_interval": 5,
  "api_port": 5001,
  "max_workers": 4
}
```

Параметры:
- `files_dir` - директория с файлами для обработки
- `db_path` - путь к файлу базы данных SQLite
- `converter_address` - адрес gRPC сервиса конвертации
- `indexer_address` - адрес gRPC сервиса индексации
- `scan_interval` - интервал между сканированиями каталога (в секундах)
- `api_port` - порт для HTTP API (для взаимодействия с веб-интерфейсом)
- `max_workers` - максимальное количество рабочих потоков для обработки файлов

## HTTP API

Микросервис предоставляет следующие API эндпоинты:

### Публичные эндпоинты (без аутентификации)
- `GET /api/stats` - статистика по файлам
- `GET /api/files` - список файлов с пагинацией и фильтрацией
- `GET /api/status` - статус сервиса
- `GET /api/config` - безопасные параметры конфигурации
- `GET /health` - проверка работоспособности сервиса
- `GET /metrics` - метрики производительности и состояния сервиса

### Защищенные эндпоинты (требуют аутентификации)
- `POST /api/control/start` - запуск обработки
- `POST /api/control/stop` - остановка обработки
- `POST /api/file/{id}/retry` - повторная обработка файла
- `DELETE /api/file/{id}` - удаление файла
- `POST /api/manual_scan` - ручное сканирование

### Параметры запросов для `/api/files`
- `page` (int) - номер страницы (по умолчанию 1)
- `limit` (int) - количество файлов на странице (по умолчанию 10, максимум 100)
- `offset` (int) - смещение для пагинации
- `status` (str) - фильтр по статусу файла

## Аутентификация

Микросервис поддерживает Basic Authentication для защищенных эндпоинтов. Аутентификация настраивается через переменные окружения:

- `MANAGER_REQUIRE_AUTH` - включить аутентификацию (true/false, по умолчанию false)
- `MANAGER_USERNAME` - имя пользователя (по умолчанию admin)
- `MANAGER_PASSWORD` - пароль (по умолчанию admin)

Пример использования:
```bash
export MANAGER_REQUIRE_AUTH=true
export MANAGER_USERNAME=myuser
export MANAGER_PASSWORD=mypassword
python manager.py
```

## Метрики и мониторинг

Микросервис предоставляет эндпоинт `/metrics` для мониторинга:
- `queue_size` - размер очереди обработки файлов
- `worker_threads` - количество рабочих потоков
- `is_running` - статус работы сервиса
- `file_stats` - статистика по файлам

## Веб-интерфейс

Веб-интерфейс вынесен в отдельный микросервис. Для запуска:

1. Перейдите в директорию `services/web_ui`
2. Установите зависимости: `pip install -r requirements.txt`
3. Запустите веб-интерфейс: `python web_ui_service.py`

Веб-интерфейс будет доступен по адресу http://localhost:5000 и будет взаимодействовать с основным сервисом через HTTP API.

## Безопасность

Микросервис включает несколько уровней безопасности:

### Проверка путей к файлам
- Защита от атак path traversal (../)
- Проверка, что все пути к файлам находятся внутри разрешенного каталога
- Нормализация и разрешение путей для предотвращения обхода безопасности

### Аутентификация
- Поддержка Basic Authentication для защищенных эндпоинтов
- Использование hmac.compare_digest для предотвращения атак по времени
- Возможность включения/выключения аутентификации через переменные окружения

### Защита базы данных
- Использование WAL режима SQLite для лучшей конкурентности
- Потокобезопасная работа с базой данных
- Проверка целостности базы данных

## Зависимости

- Python 3.7+
- grpcio
- grpcio-tools
- protobuf
- sqlite3
- flask
- requests

## Устранение неполадок

### Проблемы со сканированием файлов

Если manager не сканирует папку `files` и не начинает обрабатывать файлы:

1. **Проверьте логи** - внимательно изучите логи manager на наличие ошибок базы данных, особенно `OperationalError` или `database is locked`.

2. **Проверьте запуск необходимых сервисов** - убедитесь, что сервисы converter (порт 50053) и indexer (порт 50054) запущены и доступны.

3. **Проверьте права доступа к файлам** - убедитесь, что у сервиса manager есть права на чтение файлов в директории `files` и запись в файл базы данных `files.db`.

4. **Проверьте целостность базы данных** - если возникают проблемы с базой данных, можно проверить целостность файла `files.db`:
   ```bash
   sqlite3 files.db "PRAGMA integrity_check;"
   ```

5. **Проверьте конфигурацию** - убедитесь, что путь к директории `files_dir` в `config.json` указан правильно и существует.

### Проблемы с обработкой файлов

Если файлы не обрабатываются или процесс зависает:

1. **Проверьте статусы файлов** - через веб-интерфейс или напрямую в базе данных проверьте, в каком статусе находятся файлы.

2. **Проверьте ошибки в логах** - изучите логи converter и indexer на наличие ошибок.

3. **Проверьте ресурсы системы** - убедитесь, что на сервере достаточно памяти и места на диске.

### Решение проблем с блокировками базы данных

Если возникают частые ошибки `database is locked`:

1. **Убедитесь, что используется WAL режим** - в новых версиях manager это настраивается автоматически, но можно проверить:
   ```bash
   sqlite3 files.db "PRAGMA journal_mode;"
   ```

2. **Ограничьте количество одновременных обработчиков** - уменьшите параметр `max_workers` в конфигурации, если возникают частые конфликты.

### Проблемы с аутентификацией

Если защищенные эндпоинты недоступны или не требуют аутентификации:

1. **Проверьте переменные окружения** - убедитесь, что `MANAGER_REQUIRE_AUTH` установлен в `true`.
2. **Проверьте учетные данные** - используйте правильные имя пользователя и пароль при вызове защищенных эндпоинтов.