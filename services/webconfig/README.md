# Микросервис WebConfig

Микросервис WebConfig предоставляет веб-интерфейс для управления конфигурациями всех других микросервисов в системе RAG.

## Обзор

Этот сервис позволяет:
- Просматривать конфигурации всех микросервисов, у которых есть файлы config.json
- Редактировать конфигурации через веб-интерфейс
- Сохранять изменения непосредственно в соответствующие файлы config.json
- Управлять запуском/остановкой/перезапуском сервисов
- Просматривать логи сервисов
- Управлять gRPC соединениями между сервисами
- Просматривать и редактировать proto файлы

В системе RAG включены следующие микросервисы:
- converter: конвертация документов
- chunker: разделение текста на фрагменты
- embedder: генерация эмбеддингов
- indexer: индексация документов
- searcher: семантический поиск
- web_ui: веб-интерфейс для управления (теперь с поддержкой конфигурации)
- websearch: веб-интерфейс поиска
- webconfig: веб-интерфейс управления конфигурациями (теперь с поддержкой конфигурации)
- generator: генерация ответов на основе поисковой выдачи (новый)

## Возможности

- Централизованное управление конфигурациями
- Веб-интерфейс пользователя
- Обновление файлов конфигурации в реальном времени
- Поддержка вложенных объектов конфигурации
- Управление жизненным циклом сервисов (запуск, остановка, перезапуск)
- Просмотр логов сервисов
- Управление gRPC соединениями между сервисами
- Просмотр и редактирование proto файлов
- Улучшенное обнаружение процессов Flask-приложений (включая web_ui)
- Расширенная поддержка специфических файлов сервисов

## Установка

```bash
pip install -r requirements.txt
```

## Использование

Запустите сервис:

```bash
python webconfig.py
```

Веб-интерфейс будет доступен по адресу `http://localhost:50055`

## Конфигурация

Сервис поддерживает следующие переменные окружения:

- `WEB_CONFIG_USERNAME` - имя пользователя для аутентификации
- `WEB_CONFIG_PASSWORD` - пароль для аутентификации
- `WEB_CONFIG_REQUIRE_AUTH` - требовать аутентификацию (1/0, по умолчанию 1)
- `WEB_CONFIG_CORS_ORIGINS` - разрешенные источники для CORS
- `WEB_CONFIG_DEBUG` - режим отладки (1/0, по умолчанию 0)

Сервис также поддерживает конфигурацию через файл config.json:

```json
{
  "server": {
    "host": "0.0.0.0",
    "port": 50055,
    "debug": false
  },
  "cors": {
    "origins": [
      "http://localhost:3000",
      "http://localhost:8000",
      "http://localhost:8001"
    ]
  },
  "logging": {
    "level": "INFO",
    "file": "webconfig.log",
    "format": "%(asctime)s [%(levelname)s] %(name)s: %(message)s"
  }
}
```

## Конечные точки

- `/` - Главная панель, отображающая все сервисы и их конфигурации
- `/service/<service_name>` - Редактор конфигурации для конкретного сервиса
- `/update/<service_name>` - API-эндпоинт для обновления конфигурации сервиса
- `/reload` - Перезагрузить все конфигурации с диска
- `/status/<service_name>` - Получить статус сервиса (запущен/остановлен)
- `/start/<service_name>` - Запустить сервис
- `/stop/<service_name>` - Остановить сервис
- `/restart/<service_name>` - Перезапустить сервис
- `/services/status` - Получить статус всех сервисов
- `/logs` - Просмотр логов всех сервисов
- `/logs/<service_name>` - Просмотр логов конкретного сервиса
- `/api/logs` - API-эндпоинт для получения логов всех сервисов
- `/api/logs/<service_name>` - API-эндпоинт для получения логов конкретного сервиса
- `/grpc_connections` - Просмотр всех gRPC соединений между сервисами
- `/api/grpc_connections` - API-эндпоинт для получения всех gRPC соединений
- `/api/grpc_connections/<service_name>` - API-эндпоинт для получения gRPC соединений конкретного сервиса
- `/api/grpc_connections/<service_name>/<target_service>` - API-эндпоинт для закрытия gRPC соединения
- `/api/grpc_connections/<service_name>/<target_service>/health` - API-эндпоинт для проверки здоровья gRPC соединения
- `/protos` - Просмотр всех proto файлов в системе
- `/protos/<service_name>` - Просмотр proto файлов для конкретного сервиса
- `/protos/edit/<service_name>/<path:proto_filename>` - Редактирование конкретного proto файла
- `/api/protos` - API-эндпоинт для получения всех proto файлов
- `/api/protos/<service_name>` - API-эндпоинт для получения proto файлов конкретного сервиса
- `/api/protos/<service_name>/<path:proto_filename>` - API-эндпоинт для получения содержимого proto файла
- `/api/protos/<service_name>/<path:proto_filename>` - API-эндпоинт для обновления содержимого proto файла (PUT)
- `/api/proto/validate` - API-эндпоинт для проверки синтаксиса proto файла
- `/api/proto/compile` - API-эндпоинт для компиляции proto файла в pb2

## Архитектура

Сервис использует простую и понятную архитектуру, следуя принципам KISS (Keep It Simple, Stupid):

- Утилитарный класс `PathValidator` - обеспечивает проверку безопасности путей и имен сервисов
- Глобальные переменные `SERVICE_PROCESSES` и `SERVICE_PROCESSES_LOCK` - управляют процессами микросервисов с надлежащей синхронизацией
- Декоратор `service_exists_required` - устраняет дублирование кода в обработчиках маршрутов
- Функция `find_service_process` разбита на вспомогательные функции `_find_main_files` и `_search_matching_process` для лучшей читаемости
- Функции управления сервисами (`start_service`, `stop_service`, `restart_service`) используют общие вспомогательные функции для уменьшения дублирования кода
- Функция `render_config_field` разбита на вспомогательные функции `_render_dict_field`, `_render_list_field`, `_render_primitive_field`, `_format_label`, `_generate_input_field` для лучшей модульности
- Функции преобразования данных (`flatten_dict`, `unflatten_dict`, `convert_string_to_type`, `coerce_to_schema`) обеспечивают корректную обработку конфигурационных данных различных типов
- Функции работы с логами (`get_log_file_path`, `get_log_content`, `get_all_service_logs`) обеспечивают просмотр логов сервисов
- Класс `GrpcConnectionManager` - управляет gRPC соединениями между микросервисами
- Класс `ProtoFileManager` - управляет proto файлами в системе
- Класс `ProtoCompiler` - обеспечивает компиляцию proto файлов в pb2
- Функция `detect_grpc_connections` - обнаруживает gRPC соединения между сервисами на основе их конфигураций

Сервис сканирует родительскую директорию на наличие всех подкаталогов, содержащих файлы `config.json`, затем предоставляет простой интерфейс для просмотра и редактирования этих конфигураций.

Новый микросервис generator интегрирован в систему и может управляться через webconfig. Он предоставляет возможность генерации ответов на основе поисковой выдачи от searcher и используется websearch для предоставления более информативных ответов пользователю.

## Особенности обнаружения и запуска сервиса web_ui

Сервис web_ui теперь корректно поддерживается в webconfig с учетом своих специфических особенностей:

- Файл запуска: `web_ui_service.py` (в отличие от стандартного шаблона `<service_name>.py`)
- Улучшенный механизм обнаружения процессов Flask-приложений
- Специальная логика поиска главного файла для web_ui в функции `_find_main_files`
- Расширенная проверка командной строки и рабочей директории при поиске процесса

## Улучшенная логика поиска главных файлов

- Функция `_find_main_files` теперь учитывает специфические имена файлов для разных сервисов
- Для web_ui проверяется наличие файла `web_ui_service.py` в дополнение к стандартным именам
- Реализована гибкая система поиска главных файлов с приоритетом: `<service_name>.py`, `web_ui_service.py`, `main.py`, `app.py`, `server.py`
- Проверка безопасности путей и имен файлов для предотвращения path traversal атак

## Улучшенный механизм обнаружения процессов Flask-приложений

- Расширенная проверка командной строки процесса на предмет наличия ключевых слов 'python', 'flask'
- Проверка рабочей директории процесса
- Более гибкий подход к обнаружению процессов, запущенных различными способами
- Учет специфики запуска Flask-приложений через разные механизмы

## Принципы KISS

Архитектура сервиса следует принципам KISS (Keep It Simple, Stupid), обеспечивая необходимую функциональность с минимальной сложностью:

- Минимальное количество зависимостей
- Простая структура кода с понятными именами функций
- Четкое разделение ответственности между компонентами
- Легкость в сопровождении и расширении
- Прозрачная логика обработки запросов

## Безопасность и синхронизация

В упрощенной архитектуре реализованы следующие меры безопасности:

- Защита от path traversal атак при работе с именами сервисов через `PathValidator`
- Использование `hmac.compare_digest` для предотвращения timing attack при аутентификации
- Безопасное выполнение subprocess с проверкой команд
- Защита от command injection при запуске сервисов
- Правильная синхронизация доступа к общим ресурсам с использованием reentrant locks
- Валидация имен сервисов с помощью регулярных выражений
- Проверка безопасности путей к файлам и директориям

Архитектура следует принципам KISS (Keep It Simple, Stupid), обеспечивая необходимую функциональность с минимальной сложностью.

## Безопасность

Для запуска сервиса установите учетные данные аутентификации:

```
WEB_CONFIG_USERNAME=admin
WEB_CONFIG_PASSWORD=change-me
```

Дополнительные настройки:

```
WEB_CONFIG_REQUIRE_AUTH=1
WEB_CONFIG_CORS_ORIGINS=http://localhost:3000
WEB_CONFIG_DEBUG=0
```

## .env

Создайте файл `.env` в директории сервиса:

```
WEB_CONFIG_USERNAME=admin
WEB_CONFIG_PASSWORD=change-me
WEB_CONFIG_REQUIRE_AUTH=1
WEB_CONFIG_CORS_ORIGINS=http://localhost:3000
WEB_CONFIG_DEBUG=0
```

## Специфические параметры конфигурации Generator

Микросервис generator имеет следующие параметры конфигурации:

- `server`: настройки сервера (host, port, max_workers)
- `model`: параметры модели (path, n_ctx, n_threads, n_gpu_layers, temperature, top_p, repeat_penalty, max_tokens)
- `system_prompt`: системный промпт, используемый при генерации ответов
- `logging`: настройки логирования (level, file, format)

Пример config.json для generator:

```json
{
  "server": {
    "host": "[::]",
    "port": 50056,
    "max_workers": 4
  },
  "model": {
    "path": "./models/model.gguf",
    "n_ctx": 2048,
    "n_threads": 4,
    "n_gpu_layers": 0,
    "temperature": 0.7,
    "top_p": 0.9,
    "repeat_penalty": 1.1,
    "max_tokens": 1024
  },
  "system_prompt": "Вы являетесь помощником в предоставлении ответов на вопросы на основе предоставленных документов. Отвечайте точно и кратко, опираясь только на информацию, содержащуюся в документах.",
  "logging": {
    "level": "INFO",
    "file": "generator.log",
    "format": "%(asctime)s [%(levelname)s] %(name)s: %(message)s"
  }
}
```

Все стандартные функции webconfig поддерживают микросервис generator:
- Просмотр и редактирование конфигурации через веб-интерфейс
- Управление запуском/остановкой/перезапуском сервиса
- Просмотр логов сервиса

## Интеграция с другими сервисами

Теперь webconfig может управлять всеми микросервисами в системе RAG, включая:
- converter
- chunker
- embedder
- indexer
- searcher
- web_ui (с полной поддержкой обнаружения и запуска через web_ui_service.py)
- websearch
- generator
- сам webconfig (новый config.json и .env)

## Управление gRPC соединениями

Webconfig предоставляет интерфейс для управления gRPC соединениями между сервисами:
- Просмотр активных соединений
- Проверка состояния соединений
- Закрытие соединений при необходимости
- Обнаружение потенциальных соединений на основе конфигураций

## Управление proto файлами

Webconfig также позволяет:
- Просматривать все proto файлы в системе
- Редактировать proto файлы через веб-интерфейс
- Проверять синтаксис proto файлов
- Компилировать proto файлы в pb2
