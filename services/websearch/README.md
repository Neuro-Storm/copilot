# Web Search Interface - RAG Search System

Веб-интерфейс для системы семантического поиска RAG (Retrieval-Augmented Generation), который связывается с сервисом поиска (searcher) по gRPC и предоставляет удобный пользовательский интерфейс для поиска информации. Также поддерживает интеграцию с сервисом генерации (generator) для создания ответов на основе найденных документов.

## Архитектура

Система состоит из следующих компонентов:
- **embedder** - сервис, преобразующий текст в векторы
- **qdrant** - векторная база данных для поиска по схожести
- **searcher** - сервис, координирующий поиск между embedder и qdrant
- **generator** - сервис генерации ответов на основе поисковой выдачи
- **websearch** - текущий сервис, предоставляющий веб-интерфейс

Взаимодействие между сервисами происходит по протоколу gRPC.

## Функциональность

- Предоставление веб-интерфейса для поиска информации
- Интеграция с searcher сервисом для выполнения семантического поиска
- Интеграция с generator сервисом для генерации ответов на основе найденных документов
- Поддержка настраиваемых параметров поиска и генерации
- Веб-интерфейс на основе FastAPI с шаблонами Jinja2

## Структура файлов

```
websearch/
├── websearch.py            # Основной файл веб-приложения (FastAPI)
├── config.json             # JSON файл конфигурации
├── searcher_pb2_grpc.py    # gRPC определения для searcher (сгенерированные)
├── searcher_pb2.py         # Определения сообщений для searcher (сгенерированные)
├── generator_pb2_grpc.py   # gRPC определения для generator (сгенерированные)
├── generator_pb2.py        # Определения сообщений для generator (сгенерированные)
├── searcher.proto          # Определение gRPC интерфейса searcher
├── templates/              # Шаблоны HTML
│   └── index.html
├── static/                 # Статические файлы
│   └── style.css
├── websearch.log           # Файл логов (генерируется автоматически)
└── requirements.txt        # Зависимости
```

## Установка

Для установки зависимостей выполните:

```bash
pip install -r requirements.txt
```

## Конфигурация

Сервер использует следующие параметры конфигурации:

- `SEARCHER_HOST` - адрес сервиса searcher (по умолчанию: localhost)
- `SEARCHER_PORT` - порт сервиса searcher (по умолчанию: 50052)
- `GENERATOR_HOST` - адрес сервиса generator (по умолчанию: localhost)
- `GENERATOR_PORT` - порт сервиса generator (по умолчанию: 50056)
- `ENABLE_GENERATION` - включение генерации ответов (по умолчанию: false)
- `WEB_SERVER_HOST` - хост для запуска веб-сервера (по умолчанию: 0.0.0.0)
- `WEB_SERVER_PORT` - порт веб-сервера (по умолчанию: 8001)
- `GRPC_TIMEOUT` - таймаут для gRPC запросов в секундах (по умолчанию: 30.0)
- `MAX_QUERY_LENGTH` - максимальная длина поискового запроса (по умолчанию: 1000)
- `TEMPLATES_DIR` - директория шаблонов (по умолчанию: "templates")
- `STATIC_DIR` - директория статических файлов (по умолчанию: "static")

Конфигурация может быть задана через файл `config.json` или через переменные окружения:

```bash
export SEARCHER_HOST=localhost
export SEARCHER_PORT=50052
export GENERATOR_HOST=localhost
export GENERATOR_PORT=50056
export ENABLE_GENERATION=true
export WEB_SERVER_PORT=8001
```

Пример файла `config.json`:

```json
{
  "SEARCHER_HOST": "localhost",
  "SEARCHER_PORT": 50052,
  "GENERATOR_HOST": "localhost",
  "GENERATOR_PORT": 50056,
  "ENABLE_GENERATION": true,
  "WEB_SERVER_HOST": "0.0.0.0",
  "WEB_SERVER_PORT": 8001,
  "GRPC_TIMEOUT": 30.0,
  "MAX_QUERY_LENGTH": 1000,
  "TEMPLATES_DIR": "templates",
  "STATIC_DIR": "static"
}
```

## Запуск

Для запуска сервера выполните:

```bash
python websearch.py
```

По умолчанию веб-сервер запускается на порту 8001:

После запуска веб-интерфейс будет доступен по адресу: [http://localhost:8001](http://localhost:8001)

## Подключение к searcher и generator сервисам

Веб-интерфейс подключается к searcher сервису на порту 50052 (по умолчанию) и к generator сервису на порту 50056 (по умолчанию), что соответствует настройкам в конфигурации этих сервисов.

## API

Сервер предоставляет следующие API-эндпоинты:

- `GET /` - основная страница поиска
- `POST /api/search` - эндпоинт для выполнения поиска (принимает JSON с полем query и опциональным флагом enable_generation)
- `GET /api/health` - проверка работоспособности сервиса

Пример запроса к API с генерацией ответа:

```json
{
  "query": "Ваш поисковый запрос",
  "enable_generation": true
}
```

Пример ответа с генерацией:

```json
{
  "results": [
    {
      "text": "Текст найденного документа...",
      "score": 0.95,
      "source_id": "doc_123",
      "metadata": {}
    }
  ],
  "search_time": 0.123,
  "query": "Ваш поисковый запрос",
  "generation": {
    "answer": "Сгенерированный ответ на основе найденных документов...",
    "sources": ["doc_123"],
    "generation_time": 1.234,
    "total_generation_time": 1.567
  }
}
```

## Протокол gRPC

Сервис использует протокол gRPC для связи с searcher и generator. Определения протоколов находятся в файлах `searcher_pb2.py`, `searcher_pb2_grpc.py`, `generator_pb2.py` и `generator_pb2_grpc.py`.

Сообщения для searcher:
- `SearchRequest` - запрос на поиск, содержит строку query
- `SearchResult` - результат поиска, содержит текст, оценку схожести, ID источника и метаданные
- `SearchResponse` - ответ на запрос, содержит массив результатов и время поиска

Сообщения для generator:
- `GenerationRequest` - запрос на генерацию, содержит поисковый запрос и результаты поиска
- `GenerationResponse` - ответ на запрос генерации, содержит сгенерированный ответ, источники и время генерации

## Диагностика и устранение неполадок

Если вы сталкиваетесь с ошибками при поиске:

1. **"Метод поиска не реализован на сервере searcher"**: Убедитесь, что сервис searcher запущен и реализует метод `Search` в соответствии с proto-файлом.

2. **"Сервис searcher недоступен"**: Проверьте, что адрес и порт searcher сервиса правильно указаны в конфигурации.

3. **"UNIMPLEMENTED: Method not found!"**: Сервер searcher не реализует требуемый метод. Проверьте, что proto-файлы на сервере и клиенте идентичны.

4. **"Сервис generator недоступен"**: Убедитесь, что сервис generator запущен и адрес/порт указаны правильно в конфигурации.

5. **"Генерация ответов не работает"**: Проверьте, что `ENABLE_GENERATION` установлен в `true` и сервис generator доступен.

Для проверки соединения с searcher и generator сервисами можно использовать:
```bash
python -m pytest tests/test_connection.py -v
```

## Использование генерации ответов

Для использования генерации ответов на основе найденных документов:

1. Убедитесь, что сервис generator запущен
2. Установите `ENABLE_GENERATION` в `true` в конфигурации
3. При вызове `/api/search` передайте `"enable_generation": true` в теле запроса
4. В ответе будет дополнительное поле `generation` с результатами генерации

## Настройка

Для корректной работы сервиса с генерацией ответов необходимо:
1. Запустить сервис generator
2. Убедиться, что порт 50056 (или другой, указанный в конфиге) доступен для generator
3. Установить `ENABLE_GENERATION` в `true` в конфигурации
4. Убедиться, что пути к шаблонам и статическим файлам указаны правильно